[build]
target = "index.html"
dist = "dist"

# Inject build hash into service worker for cache busting
[[hooks]]
stage = "post_build"
command = "sh"
command_arguments = ["-c", """
HASH=$(grep -oP 'frontend-\\K[a-f0-9]+(?=\\.js)' $TRUNK_STAGING_DIR/index.html | head -1)
if [ -n "$HASH" ]; then
  sed -i "s/__BUILD_HASH__/$HASH/g" $TRUNK_STAGING_DIR/sw.js
  echo "Injected build hash $HASH into sw.js"
fi
"""]

[watch]
watch = ["src", "index.html", "styles.css", "manifest.json", "sw.js", "favicon.svg", "icons"]

[serve]
addresses = ["127.0.0.1"]
port = 3000

# Proxy API requests to backend during development
[[proxy]]
ws = true
rewrite = "/api/ws"
backend = "http://127.0.0.1:8080/api/ws"

[[proxy]]
rewrite = "/api/"
backend = "http://127.0.0.1:8080/api/"

